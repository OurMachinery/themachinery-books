<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Creating Custom Geometry Nodes - The Machinery Tutorial Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../index.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item "><a href="../workflows/how_to_create_prototypes.html"><strong aria-hidden="true">2.</strong> How to Create Prototypes</a></li><li class="chapter-item "><a href="../workflows/how_to_instantiate_prototypes.html"><strong aria-hidden="true">3.</strong> How to Instantiate Prototypes</a></li><li class="chapter-item expanded "><a href="../creation_graph/index.html"><strong aria-hidden="true">4.</strong> Creation Graph</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../creation_graph/introduction_walkthrough/index.html"><strong aria-hidden="true">4.1.</strong> Creation Graph Introduction Series</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../creation_graph/introduction_walkthrough/texture_compression.html"><strong aria-hidden="true">4.1.1.</strong> Simple Texture Compression</a></li><li class="chapter-item "><a href="../creation_graph/introduction_walkthrough/creation_graph_prototype.html"><strong aria-hidden="true">4.1.2.</strong> Creation Graph Prototype</a></li><li class="chapter-item "><a href="../creation_graph/introduction_walkthrough/custom_import_settings.html"><strong aria-hidden="true">4.1.3.</strong> Custom Import Settings</a></li></ol></li><li class="chapter-item "><a href="../creation_graph/custom_gpu_nodes.html"><strong aria-hidden="true">4.2.</strong> Creating Custom GPU Nodes</a></li><li class="chapter-item "><a href="../creation_graph/custom_cpu_nodes.html"><strong aria-hidden="true">4.3.</strong> Creating Custom CPU Nodes</a></li><li class="chapter-item expanded "><a href="../creation_graph/custom_geometry_node.html" class="active"><strong aria-hidden="true">4.4.</strong> Creating Custom Geometry Nodes</a></li><li class="chapter-item "><a href="../creation_graph/from_code.html"><strong aria-hidden="true">4.5.</strong> Calling Creation Graphs from Code</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../creation_graph/raymarch_output_node.html"><strong aria-hidden="true">4.5.1.</strong> Creating a Custom Raymarching Output Node</a></li></ol></li></ol></li><li class="chapter-item "><a href="../post_processing/index.html"><strong aria-hidden="true">5.</strong> Post Processing</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../post_processing/aa.html"><strong aria-hidden="true">5.1.</strong> Anti-Aliasing</a></li><li class="chapter-item "><a href="../post_processing/exposure.html"><strong aria-hidden="true">5.2.</strong> Exposure</a></li><li class="chapter-item "><a href="../post_processing/bloom.html"><strong aria-hidden="true">5.3.</strong> Bloom</a></li><li class="chapter-item "><a href="../post_processing/color_grading.html"><strong aria-hidden="true">5.4.</strong> Color Grading</a></li></ol></li><li class="chapter-item "><a href="../physics/index.html"><strong aria-hidden="true">6.</strong> Physics</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../physics/triggers.html"><strong aria-hidden="true">6.1.</strong> Triggers</a></li></ol></li><li class="chapter-item "><a href="../the_truth/index.html"><strong aria-hidden="true">7.</strong> The Truth</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../the_truth/custom_asset/index.html"><strong aria-hidden="true">7.1.</strong> Creating a Custom Asset Type</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../the_truth/custom_asset/part1.html"><strong aria-hidden="true">7.1.1.</strong> Part 1 - Create an Asset Truth Type, Addable via Asset Browser</a></li><li class="chapter-item "><a href="../the_truth/custom_asset/part2.html"><strong aria-hidden="true">7.1.2.</strong> Part 2 - Custom UI</a></li><li class="chapter-item "><a href="../the_truth/custom_asset/part3.html"><strong aria-hidden="true">7.1.3.</strong> Part 3 - Custom Importer</a></li></ol></li><li class="chapter-item "><a href="../the_truth/drag_and_drop.html"><strong aria-hidden="true">7.2.</strong> Adding Drag and Drop to Assets</a></li><li class="chapter-item "><a href="../the_truth/open_asset.html"><strong aria-hidden="true">7.3.</strong> Open Asset in Tab</a></li></ol></li><li class="chapter-item "><a href="../gameplay_coding/index.html"><strong aria-hidden="true">8.</strong> Gameplay Coding</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../gameplay_coding/extend_the_entity_graph.html"><strong aria-hidden="true">8.1.</strong> Extending the Entity Graph</a></li><li class="chapter-item "><a href="../gameplay_coding/provide_custom_data_type_to_the_entity_graph.html"><strong aria-hidden="true">8.2.</strong> Custom Data Type for the Entity Graph</a></li></ol></li><li class="chapter-item "><a href="../network/index.html"><strong aria-hidden="true">9.</strong> Network</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../network/animation_sample/network_assets.html"><strong aria-hidden="true">9.1.</strong> Part 1: Network Asset</a></li><li class="chapter-item "><a href="../network/animation_sample/multiple_network_instances.html"><strong aria-hidden="true">9.2.</strong> Part 2: Multiple Instances</a></li><li class="chapter-item "><a href="../network/animation_sample/entity_control.html"><strong aria-hidden="true">9.3.</strong> Part 3: Entity Control</a></li><li class="chapter-item "><a href="../network/animation_sample/support_multiple_players.html"><strong aria-hidden="true">9.4.</strong> Part 4: Multiple Players</a></li><li class="chapter-item "><a href="../network/animation_sample/basic_graph_variables.html"><strong aria-hidden="true">9.5.</strong> Part 5: Variable Replication (Graph)</a></li><li class="chapter-item "><a href="../network/animation_sample/smooth_animation.html"><strong aria-hidden="true">9.6.</strong> Part 6: Smooth Animation</a></li><li class="chapter-item "><a href="../network/animation_sample/spawning_entities.html"><strong aria-hidden="true">9.7.</strong> Part 7: Spawning Entities</a></li></ol></li><li class="chapter-item "><a href="../ui/index.html"><strong aria-hidden="true">10.</strong> UI</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ui/build_custom_ui_controls/index.html"><strong aria-hidden="true">10.1.</strong> Build Custom UI Controls</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ui/build_custom_ui_controls/part1.html"><strong aria-hidden="true">10.1.1.</strong> Part 1</a></li></ol></li><li class="chapter-item "><a href="../ui/toolbars-overlays.html"><strong aria-hidden="true">10.2.</strong> Toolbars and Overlays</a></li><li class="chapter-item "><a href="../ui/custom_layouts.html"><strong aria-hidden="true">10.3.</strong> Custom Tab Layouts</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Machinery Tutorial Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/OurMachinery/themachinery-books" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="creating-custom-geometry-nodes"><a class="header" href="#creating-custom-geometry-nodes">Creating Custom Geometry Nodes</a></h1>
<p>In this tutorial we well be creating a CPU node for the <a href="https://ourmachinery.github.io/themachinery-books/the_machinery_book//creation_graphs/concept.html"><em>Creation Graph</em></a> that creates a mesh that can be used by rendering nodes. This tutorial expects some basic knowledge of the creation graph and node creation. it is recommended to read <a href="https://ourmachinery.github.io/themachinery-books/tutorials//creation_graph/custom_cpu_nodes.html"><em>Creating custom CPU nodes</em></a> before reading this.</p>
<p><img src="https://www.dropbox.com/s/5xbu16zov1k5h4b/tm_tut_creation_graph_geometry_node.png?dl=1" alt="" /></p>
<p>The main output of this node will be a <a href="https://ourmachinery.com/apidoc/plugins/creation_graph/geometry_nodes.h.html#structtm_gpu_geometry_t">tm_gpu_geometry_t</a> and a <a href="https://ourmachinery.com/apidoc/plugins/renderer/commands.h.html#structtm_renderer_draw_call_info_t">tm_renderer_draw_call_info_t</a>. Together these will make out <code>GPU Geometry</code> output. Additionally we will be outputting a bounding box for the triangle that can be used for culling and other calculations. But before we can populate those, we’ll need to consider the vertex format of our mesh. For this example, this will be a simple position, normal, and color per vertex:</p>
<pre><code class="language-c">typedef struct tm_triangle_vertex_t
{
    tm_vec3_t pos;
    tm_vec3_t normal;
    tm_vec3_t color;
} tm_triangle_vertex_t;

</code></pre>
<p>The <a href="https://ourmachinery.com/apidoc/plugins/renderer/commands.h.html#structtm_renderer_draw_call_info_t">tm_renderer_draw_call_info_t</a> is constant for our example so we can populate it as follows: (note that this node doesn’t create an index buffer and thusly uses <a href="https://ourmachinery.com/apidoc/plugins/renderer/commands.h.html#enumtm_renderer_draw_type">TM_RENDERER_DRAW_TYPE_NON_INDEXED</a>)</p>
<pre><code class="language-c">const uint32_t geometry_wire_size = sizeof(tm_gpu_geometry_t) + sizeof(tm_renderer_draw_call_info_t);
uint8_t *geometry_wire_data = tm_creation_graph_interpreter_api-&gt;write_wire(ctx-&gt;instance, ctx-&gt;wires[0], TM_TYPE_HASH__GPU_GEOMETRY, 1, geometry_wire_size);
memset(geometry_wire_data, 0, geometry_wire_size);

tm_renderer_draw_call_info_t *draw_call = (tm_renderer_draw_call_info_t *)(geometry_wire_data + sizeof(tm_gpu_geometry_t));
*draw_call = (tm_renderer_draw_call_info_t) {
    .primitive_type = TM_RENDERER_PRIMITIVE_TYPE_TRIANGLE_LIST,
    .draw_type = TM_RENDERER_DRAW_TYPE_NON_INDEXED,
    .non_indexed.num_vertices = 3,
    .non_indexed.num_instances = 1
};

</code></pre>
<p>Creating the geometry for this node requires us to take several things into consideration. First, we  need to store the vertex buffer, constant buffer, and resource binder somewhere. Thankfully, the creation graph has a resource caching system that will handle this storage for us. Second, we need to define the system required to query our mesh primitives. For most use cases, the default <code>vertex_buffer_system</code> is the best option. Third, we need to ask ourselves what this geometry will be used for. If the geometry should be visible to the ray tracing pipeline for instance. This is a design choice that should be made by the node creator. In this example, we will take ray tracing into account.</p>
<p>First, let us query the default <code>vertex_buffer_system</code>, if this is not available our node will not work so we can early out:</p>
<pre><code class="language-c">gpu_geometry-&gt;vfetch_system = tm_shader_repository_api-&gt;lookup_system(context-&gt;shader_repository, TM_STATIC_HASH(&quot;vertex_buffer_system&quot;, 0x6289889fc7c40280ULL));

</code></pre>
<p>Next we will be creating the resources needed for our node. This will be a <a href="https://ourmachinery.com/apidoc/plugins/shader_system/shader_system.h.html#structtm_shader_constant_buffer_instance_t">tm_shader_constant_buffer_instance_t</a>, a <a href="https://ourmachinery.com/apidoc/plugins/shader_system/shader_system.h.html#structtm_shader_resource_binder_instance_t">tm_shader_resource_binder_instance_t</a>, and a GPU buffer:</p>
<pre><code class="language-c">tm_creation_graph_node_cache_t *node_cache = tm_creation_graph_api-&gt;lock_resource_cache(context-&gt;tt, ctx-&gt;graph_id, ctx-&gt;node_id);
tm_shader_io_o *io = tm_shader_api-&gt;system_io(gpu_geometry-&gt;vfetch_system);

tm_shader_constant_buffer_instance_t *cbuffer = (tm_shader_constant_buffer_instance_t *)node_cache-&gt;scratch_pad;
tm_shader_resource_binder_instance_t *rbinder = (tm_shader_resource_binder_instance_t *)node_cache-&gt;scratch_pad + sizeof(tm_shader_constant_buffer_instance_t);

if (!cbuffer-&gt;instance_id)
    tm_shader_api-&gt;create_constant_buffer_instances(io, 1, cbuffer);
if (!rbinder-&gt;instance_id)
    tm_shader_api-&gt;create_resource_binder_instances(io, 1, rbinder);

gpu_geometry-&gt;vfetch_system_cbuffer = cbuffer-&gt;instance_id;
gpu_geometry-&gt;vfetch_system_rbinder = rbinder-&gt;instance_id;

if (!node_cache-&gt;handles[0].resource) {
    const tm_renderer_buffer_desc_t vbuf_desc = {
        .size = 3 * sizeof(tm_triangle_vertex_t),
        .usage_flags = TM_RENDERER_BUFFER_USAGE_STORAGE | TM_RENDERER_BUFFER_USAGE_ACCELERATION_STRUCTURE,
        .debug_tag = &quot;geometry__triangle_vbuf&quot;
    };

    tm_triangle_vertex_t *vbuf_data;
    node_cache-&gt;handles[0] = tm_renderer_api-&gt;tm_renderer_resource_command_buffer_api-&gt;map_create_buffer(res_buf, &amp;vbuf_desc, TM_RENDERER_DEVICE_AFFINITY_MASK_ALL, 0, (void **)&amp;vbuf_data);

</code></pre>
<p>Now that our buffer has been created; we can start populating it with our vertex data:</p>
<pre><code class="language-c">vbuf_data[0] = (tm_triangle_vertex_t) { .pos = (tm_vec3_t) { 0.0f, 1.0f, 0.0f }, .normal = (tm_vec3_t) { 0.0f, 0.0f, 1.0f }, .color = (tm_vec3_t) { 1.0f, 0.0f, 0.0f } };
vbuf_data[2] = (tm_triangle_vertex_t) { .pos = (tm_vec3_t) { 1.0f, -1.0f, 0.0f }, .normal = (tm_vec3_t) { 0.0f, 0.0f, 1.0f }, .color = (tm_vec3_t) { 0.0f, 1.0f, 0.0f } };
vbuf_data[1] = (tm_triangle_vertex_t) { .pos = (tm_vec3_t) { -1.0f, -1.0f, 0.0f }, .normal = (tm_vec3_t) { 0.0f, 0.0f, 1.0f }, .color = (tm_vec3_t) { 0.0f, 0.0f, 1.0f } };

</code></pre>
<p>Finally, we need to tell the <code>vertex_buffer_system</code> which primitives are available in our mesh and how it should access them. This is what the constant buffer and resource binder are for. Note that the layout for the vertex buffer system can be included from the <a href="https://ourmachinery.com/apidoc/the_machinery/shaders/vertex_buffer_system.inl.html#vertex_buffer_system.inl">vertex_buffer_system</a> file:</p>
<pre><code class="language-c">tm_shader_vertex_buffer_system_t constants = { 0 };
constants.vertex_buffer_header[0] |= (1 &lt;&lt; TM_VERTEX_SEMANTIC_POSITION) | (1 &lt;&lt; TM_VERTEX_SEMANTIC_NORMAL) | (1 &lt;&lt; TM_VERTEX_SEMANTIC_COLOR0);

uint32_t *offsets = (uint32_t *)&amp;constants.vertex_buffer_offsets;
offsets[TM_VERTEX_SEMANTIC_POSITION] = tm_offset_of(tm_triangle_vertex_t, pos);
offsets[TM_VERTEX_SEMANTIC_NORMAL] = tm_offset_of(tm_triangle_vertex_t, normal);
offsets[TM_VERTEX_SEMANTIC_COLOR0] = tm_offset_of(tm_triangle_vertex_t, color);

uint32_t *strides = (uint32_t *)&amp;constants.vertex_buffer_strides;
strides[TM_VERTEX_SEMANTIC_POSITION] = sizeof(tm_triangle_vertex_t);
strides[TM_VERTEX_SEMANTIC_NORMAL] = sizeof(tm_triangle_vertex_t);
strides[TM_VERTEX_SEMANTIC_COLOR0] = sizeof(tm_triangle_vertex_t);

void *cbuf = (void *)&amp;constants;
tm_shader_api-&gt;update_constants_raw(io, res_buf, &amp;cbuffer-&gt;instance_id, &amp;cbuf, 0, sizeof(tm_shader_vertex_buffer_system_t), 1);

uint32_t pos_buffer_slot, normal_buffer_slot, color_buffer_slot;
tm_shader_api-&gt;lookup_resource(io, TM_STATIC_HASH(&quot;vertex_buffer_position_buffer&quot;, 0x1ef08bede3820d69ULL), NULL, &amp;pos_buffer_slot);
tm_shader_api-&gt;lookup_resource(io, TM_STATIC_HASH(&quot;vertex_buffer_normal_buffer&quot;, 0x781ed2624b12ebbcULL), NULL, &amp;normal_buffer_slot);
tm_shader_api-&gt;lookup_resource(io, TM_STATIC_HASH(&quot;vertex_buffer_color0_buffer&quot;, 0xb808f20e2f260026ULL), NULL, &amp;color_buffer_slot);

const tm_shader_resource_update_t res_updates[] = {
    { .instance_id = rbinder-&gt;instance_id,
        .resource_slot = pos_buffer_slot,
        .num_resources = 1,
        .resources = node_cache-&gt;handles },
    { .instance_id = rbinder-&gt;instance_id,
        .resource_slot = normal_buffer_slot,
        .num_resources = 1,
        .resources = node_cache-&gt;handles },
    { .instance_id = rbinder-&gt;instance_id,
        .resource_slot = color_buffer_slot,
        .num_resources = 1,
        .resources = node_cache-&gt;handles }
};

tm_shader_api-&gt;update_resources(io, res_buf, res_updates, TM_ARRAY_COUNT(res_updates));

</code></pre>
<p>And now we have our triangle, we just have to unlock the resource cache again and set the bounding volume outputs:</p>
<pre><code class="language-c">tm_creation_graph_api-&gt;unlock_resource_cache(node_cache);
}

tm_vec3_t *bounds_min = tm_creation_graph_interpreter_api-&gt;write_wire(ctx-&gt;instance, ctx-&gt;wires[1], TM_TT_TYPE_HASH__VEC3, 1, sizeof(tm_vec3_t));
tm_vec3_t *bounds_max = tm_creation_graph_interpreter_api-&gt;write_wire(ctx-&gt;instance, ctx-&gt;wires[2], TM_TT_TYPE_HASH__VEC3, 1, sizeof(tm_vec3_t));

*bounds_min = (tm_vec3_t) { -1.0f, -1.0f, 0.0f };
*bounds_max = (tm_vec3_t) { 1.0f, 1.0f, 0.0f };

</code></pre>
<p>This is the full source code to define this creation graph CPU node:</p>
<pre><code class="language-c">static struct tm_creation_graph_api *tm_creation_graph_api;
static struct tm_creation_graph_interpreter_api *tm_creation_graph_interpreter_api;
static struct tm_shader_api *tm_shader_api;
static struct tm_shader_repository_api *tm_shader_repository_api;
static struct tm_renderer_api *tm_renderer_api;

#include &lt;foundation/api_registry.h&gt;
#include &lt;foundation/atomics.inl&gt;
#include &lt;foundation/macros.h&gt;
#include &lt;foundation/the_truth_types.h&gt;

#include &lt;plugins/creation_graph/creation_graph.h&gt;
#include &lt;plugins/creation_graph/creation_graph_interpreter.h&gt;
#include &lt;plugins/creation_graph/creation_graph_node_type.h&gt;
#include &lt;plugins/creation_graph/geometry_nodes.h&gt;
#include &lt;plugins/renderer/commands.h&gt;
#include &lt;plugins/renderer/render_backend.h&gt;
#include &lt;plugins/renderer/render_command_buffer.h&gt;
#include &lt;plugins/renderer/renderer.h&gt;
#include &lt;plugins/renderer/resources.h&gt;
#include &lt;plugins/shader_system/shader_system.h&gt;

#include &lt;string.h&gt;

#include &lt;plugins/creation_graph/resource_cache.inl&gt;
typedef struct tm_triangle_vertex_t
{
    tm_vec3_t pos;
    tm_vec3_t normal;
    tm_vec3_t color;
} tm_triangle_vertex_t;

static void triangle_node__compile(tm_creation_graph_interpreter_context_t *ctx, tm_creation_graph_compile_context_t *compile_ctx)
{
    tm_creation_graph_context_t *context = *(tm_creation_graph_context_t **)tm_creation_graph_interpreter_api-&gt;read_wire(ctx-&gt;instance, TM_CREATION_GRAPH__STATIC_WIRE__CONTEXT).data;
    if (!context)
        return;
    const uint32_t geometry_wire_size = sizeof(tm_gpu_geometry_t) + sizeof(tm_renderer_draw_call_info_t);
    uint8_t *geometry_wire_data = tm_creation_graph_interpreter_api-&gt;write_wire(ctx-&gt;instance, ctx-&gt;wires[0], TM_TYPE_HASH__GPU_GEOMETRY, 1, geometry_wire_size);
    memset(geometry_wire_data, 0, geometry_wire_size);

    tm_renderer_draw_call_info_t *draw_call = (tm_renderer_draw_call_info_t *)(geometry_wire_data + sizeof(tm_gpu_geometry_t));
    *draw_call = (tm_renderer_draw_call_info_t) {
        .primitive_type = TM_RENDERER_PRIMITIVE_TYPE_TRIANGLE_LIST,
        .draw_type = TM_RENDERER_DRAW_TYPE_NON_INDEXED,
        .non_indexed.num_vertices = 3,
        .non_indexed.num_instances = 1
    };

    tm_gpu_geometry_t *gpu_geometry = (tm_gpu_geometry_t *)geometry_wire_data;
    gpu_geometry-&gt;vfetch_system = tm_shader_repository_api-&gt;lookup_system(context-&gt;shader_repository, TM_STATIC_HASH(&quot;vertex_buffer_system&quot;, 0x6289889fc7c40280ULL));
    if (gpu_geometry-&gt;vfetch_system) {
#include &lt;the_machinery/shaders/vertex_buffer_system.inl&gt;

        tm_renderer_resource_command_buffer_o *res_buf = context-&gt;res_buf[TM_CREATION_GRAPH_RESOURCE_BUFFERS__PRE_CMD];
        tm_creation_graph_node_cache_t *node_cache = tm_creation_graph_api-&gt;lock_resource_cache(context-&gt;tt, ctx-&gt;graph_id, ctx-&gt;node_id);
        tm_shader_io_o *io = tm_shader_api-&gt;system_io(gpu_geometry-&gt;vfetch_system);

        tm_shader_constant_buffer_instance_t *cbuffer = (tm_shader_constant_buffer_instance_t *)node_cache-&gt;scratch_pad;
        tm_shader_resource_binder_instance_t *rbinder = (tm_shader_resource_binder_instance_t *)node_cache-&gt;scratch_pad + sizeof(tm_shader_constant_buffer_instance_t);

        if (!cbuffer-&gt;instance_id)
            tm_shader_api-&gt;create_constant_buffer_instances(io, 1, cbuffer);
        if (!rbinder-&gt;instance_id)
            tm_shader_api-&gt;create_resource_binder_instances(io, 1, rbinder);

        gpu_geometry-&gt;vfetch_system_cbuffer = cbuffer-&gt;instance_id;
        gpu_geometry-&gt;vfetch_system_rbinder = rbinder-&gt;instance_id;

        if (!node_cache-&gt;handles[0].resource) {
            const tm_renderer_buffer_desc_t vbuf_desc = {
                .size = 3 * sizeof(tm_triangle_vertex_t),
                .usage_flags = TM_RENDERER_BUFFER_USAGE_STORAGE | TM_RENDERER_BUFFER_USAGE_ACCELERATION_STRUCTURE,
                .debug_tag = &quot;geometry__triangle_vbuf&quot;
            };

            tm_triangle_vertex_t *vbuf_data;
            node_cache-&gt;handles[0] = tm_renderer_api-&gt;tm_renderer_resource_command_buffer_api-&gt;map_create_buffer(res_buf, &amp;vbuf_desc, TM_RENDERER_DEVICE_AFFINITY_MASK_ALL, 0, (void **)&amp;vbuf_data);
            vbuf_data[0] = (tm_triangle_vertex_t) { .pos = (tm_vec3_t) { 0.0f, 1.0f, 0.0f }, .normal = (tm_vec3_t) { 0.0f, 0.0f, 1.0f }, .color = (tm_vec3_t) { 1.0f, 0.0f, 0.0f } };
            vbuf_data[2] = (tm_triangle_vertex_t) { .pos = (tm_vec3_t) { 1.0f, -1.0f, 0.0f }, .normal = (tm_vec3_t) { 0.0f, 0.0f, 1.0f }, .color = (tm_vec3_t) { 0.0f, 1.0f, 0.0f } };
            vbuf_data[1] = (tm_triangle_vertex_t) { .pos = (tm_vec3_t) { -1.0f, -1.0f, 0.0f }, .normal = (tm_vec3_t) { 0.0f, 0.0f, 1.0f }, .color = (tm_vec3_t) { 0.0f, 0.0f, 1.0f } };
            tm_shader_vertex_buffer_system_t constants = { 0 };
            constants.vertex_buffer_header[0] |= (1 &lt;&lt; TM_VERTEX_SEMANTIC_POSITION) | (1 &lt;&lt; TM_VERTEX_SEMANTIC_NORMAL) | (1 &lt;&lt; TM_VERTEX_SEMANTIC_COLOR0);

            uint32_t *offsets = (uint32_t *)&amp;constants.vertex_buffer_offsets;
            offsets[TM_VERTEX_SEMANTIC_POSITION] = tm_offset_of(tm_triangle_vertex_t, pos);
            offsets[TM_VERTEX_SEMANTIC_NORMAL] = tm_offset_of(tm_triangle_vertex_t, normal);
            offsets[TM_VERTEX_SEMANTIC_COLOR0] = tm_offset_of(tm_triangle_vertex_t, color);

            uint32_t *strides = (uint32_t *)&amp;constants.vertex_buffer_strides;
            strides[TM_VERTEX_SEMANTIC_POSITION] = sizeof(tm_triangle_vertex_t);
            strides[TM_VERTEX_SEMANTIC_NORMAL] = sizeof(tm_triangle_vertex_t);
            strides[TM_VERTEX_SEMANTIC_COLOR0] = sizeof(tm_triangle_vertex_t);

            void *cbuf = (void *)&amp;constants;
            tm_shader_api-&gt;update_constants_raw(io, res_buf, &amp;cbuffer-&gt;instance_id, &amp;cbuf, 0, sizeof(tm_shader_vertex_buffer_system_t), 1);

            uint32_t pos_buffer_slot, normal_buffer_slot, color_buffer_slot;
            tm_shader_api-&gt;lookup_resource(io, TM_STATIC_HASH(&quot;vertex_buffer_position_buffer&quot;, 0x1ef08bede3820d69ULL), NULL, &amp;pos_buffer_slot);
            tm_shader_api-&gt;lookup_resource(io, TM_STATIC_HASH(&quot;vertex_buffer_normal_buffer&quot;, 0x781ed2624b12ebbcULL), NULL, &amp;normal_buffer_slot);
            tm_shader_api-&gt;lookup_resource(io, TM_STATIC_HASH(&quot;vertex_buffer_color0_buffer&quot;, 0xb808f20e2f260026ULL), NULL, &amp;color_buffer_slot);

            const tm_shader_resource_update_t res_updates[] = {
                { .instance_id = rbinder-&gt;instance_id,
                    .resource_slot = pos_buffer_slot,
                    .num_resources = 1,
                    .resources = node_cache-&gt;handles },
                { .instance_id = rbinder-&gt;instance_id,
                    .resource_slot = normal_buffer_slot,
                    .num_resources = 1,
                    .resources = node_cache-&gt;handles },
                { .instance_id = rbinder-&gt;instance_id,
                    .resource_slot = color_buffer_slot,
                    .num_resources = 1,
                    .resources = node_cache-&gt;handles }
            };

            tm_shader_api-&gt;update_resources(io, res_buf, res_updates, TM_ARRAY_COUNT(res_updates));
        }
        tm_creation_graph_api-&gt;unlock_resource_cache(node_cache);
    }

    tm_vec3_t *bounds_min = tm_creation_graph_interpreter_api-&gt;write_wire(ctx-&gt;instance, ctx-&gt;wires[1], TM_TT_TYPE_HASH__VEC3, 1, sizeof(tm_vec3_t));
    tm_vec3_t *bounds_max = tm_creation_graph_interpreter_api-&gt;write_wire(ctx-&gt;instance, ctx-&gt;wires[2], TM_TT_TYPE_HASH__VEC3, 1, sizeof(tm_vec3_t));

    *bounds_min = (tm_vec3_t) { -1.0f, -1.0f, 0.0f };
    *bounds_max = (tm_vec3_t) { 1.0f, 1.0f, 0.0f };
}

static tm_creation_graph_node_type_i triangle_node = {
    .name = &quot;tm_geometry_triangle&quot;,
    .display_name = &quot;Triangle&quot;,
    .category = &quot;Geometry&quot;,
    .static_connectors.num_out = 3,
    .static_connectors.out = {
        { .name = &quot;gpu_geometry&quot;, .display_name = &quot;GPU Geometry&quot;, .type_hash = TM_TYPE_HASH__GPU_GEOMETRY },
        { .name = &quot;bounds_min&quot;, .display_name = &quot;Bounds Min&quot;, .type_hash = TM_TT_TYPE_HASH__VEC3, .optional = true },
        { .name = &quot;bounds_max&quot;, .display_name = &quot;Bounds Max&quot;, .type_hash = TM_TT_TYPE_HASH__VEC3, .optional = true } },
    .compile = triangle_node__compile
};

TM_DLL_EXPORT void tm_load_plugin(struct tm_api_registry_api *reg, bool load)
{
    tm_creation_graph_api = tm_get_api(reg, tm_creation_graph_api);
    tm_creation_graph_interpreter_api = tm_get_api(reg, tm_creation_graph_interpreter_api);
    tm_shader_api = tm_get_api(reg, tm_shader_api);
    tm_shader_repository_api = tm_get_api(reg, tm_shader_repository_api);
    tm_renderer_api = tm_get_api(reg, tm_renderer_api);

    tm_add_or_remove_implementation(reg, load, tm_creation_graph_node_type_i, &amp;triangle_node);
}

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../creation_graph/custom_cpu_nodes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../creation_graph/from_code.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../creation_graph/custom_cpu_nodes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../creation_graph/from_code.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
