<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Creating custom GPU nodes - The Machinery Tutorial Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item expanded "><a href="../creation_graph/index.html"><strong aria-hidden="true">2.</strong> Creation Graph</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../creation_graph/custom_gpu_nodes.html" class="active"><strong aria-hidden="true">2.1.</strong> Creating custom GPU nodes</a></li><li class="chapter-item expanded "><a href="../creation_graph/custom_cpu_nodes.html"><strong aria-hidden="true">2.2.</strong> Creating custom CPU nodes</a></li><li class="chapter-item expanded "><a href="../creation_graph/from_code.html"><strong aria-hidden="true">2.3.</strong> Calling Creation Graphs from code</a></li></ol></li><li class="chapter-item expanded "><a href="../physics/index.html"><strong aria-hidden="true">3.</strong> Physics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../physics/triggers.html"><strong aria-hidden="true">3.1.</strong> Triggers</a></li></ol></li><li class="chapter-item expanded "><a href="../the_truth/index.html"><strong aria-hidden="true">4.</strong> The Truth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../the_truth/custom_asset/index.html"><strong aria-hidden="true">4.1.</strong> Creating a custom asset</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../the_truth/custom_asset/part1.html"><strong aria-hidden="true">4.1.1.</strong> Part 1 - Create an Asset Truth Type, Addable via Asset Browser</a></li><li class="chapter-item expanded "><a href="../the_truth/custom_asset/part2.html"><strong aria-hidden="true">4.1.2.</strong> Part 2 - Custom UI</a></li><li class="chapter-item expanded "><a href="../the_truth/custom_asset/part3.html"><strong aria-hidden="true">4.1.3.</strong> Part 3 - Custom Importer</a></li></ol></li><li class="chapter-item expanded "><a href="../the_truth/drag_and_drop.html"><strong aria-hidden="true">4.2.</strong> Adding Drag and Drop to Assets</a></li><li class="chapter-item expanded "><a href="../the_truth/open_asset.html"><strong aria-hidden="true">4.3.</strong> Open Asset in Tab</a></li></ol></li><li class="chapter-item expanded "><a href="../gameplay_coding/index.html"><strong aria-hidden="true">5.</strong> Gameplay Coding</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gameplay_coding/extend_the_visual_scripting_language.html"><strong aria-hidden="true">5.1.</strong> Extending the Visual Scripting Language</a></li></ol></li><li class="chapter-item expanded "><a href="../ui/index.html"><strong aria-hidden="true">6.</strong> UI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ui/build_custom_ui_controls/index.html"><strong aria-hidden="true">6.1.</strong> Build Custom UI Controls</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ui/build_custom_ui_controls/part1.html"><strong aria-hidden="true">6.1.1.</strong> Part 1</a></li></ol></li><li class="chapter-item expanded "><a href="../ui/toolbars-overlays.html"><strong aria-hidden="true">6.2.</strong> Toolbars and Overlays</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Machinery Tutorial Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/OurMachinery/themachinery-books" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="custom-gpu-nodes"><a class="header" href="#custom-gpu-nodes">Custom GPU nodes</a></h1>
<p>The <a href="https://ourmachinery.github.io/themachinery-books/the_machinery_book//creation_graphs/concept.html"><em>Creation Graph</em></a> is a powerful visual scripting language that can generate shader code through its GPU nodes. Extending this with custom nodes allows for more complex algorithms, custom material types and much more. In this tutorial we will demonstrate how to create some basic GPU nodes. To learn the difference between CPU and GPU nodes, check out <a href="https://ourmachinery.github.io/themachinery-books/the_machinery_book//creation_graphs/node_types.html"><em>Node Types</em></a>. </p>
<p>A creation graph CPU node needs to be in a <code>.tmsl</code> file, these can be compiled by the shader system. Note that there can only be <strong>one</strong> creation graph node per <code>.tmsl</code> file, additional definitions will be ignored. If these shaders are places in the <code>bin/data/shaders/</code> directory then they will be loaded automatically. For a full reference on the shader files, check out the <a href="https://ourmachinery.com/apidoc/doc/shader_system_reference.md.html">Shader System Reference</a>.</p>
<h2 id="cube-node"><a class="header" href="#cube-node">Cube Node</a></h2>
<p><img src="https://www.dropbox.com/s/z6faxvwm0sb7i9o/tut_creation_graph_custom_cube.png?dl=1" alt="" /></p>
<pre><code class="language-json">function: [[
	output.res = x * x * x;
]]

creation_graph_node: {
	name: &quot;tm_cube_node&quot;
	display_name: &quot;Cube&quot;
	category: &quot;Shader/Math&quot;

	inputs: [ 
		{ name: &quot;x&quot; display_name: &quot;X&quot; } 
	]
	outputs: [
		{ name: &quot;res&quot; display_name: &quot;Result&quot; type: { type_of: &quot;x&quot; } }
	]
}
</code></pre>
<p>This node show you the absolute basics of making a creation graph GPU node. All GPU nodes require two blocks. The <code>function</code> block is where you actual shader code will end up. The <code>creation_graph_node</code> is a meta node that defines you node I/O and general information.</p>
<p>In this example the <code>creation_graph_node</code> has several fields, but more can be defined:</p>
<ul>
<li><code>name</code> is the unique identifier for you node, it’s a good idea to prefix this with your namespace.</li>
<li><code>display_name</code> specifies an optional name of the node shown in the editor UI, if this is not defined then the node will get an automatically generated name based on the <code>name</code> field.</li>
<li><code>category</code> is an optional path-type string that allows you to group related nodes.</li>
<li><code>inputs</code> is an array of input parameters for this node, a type can be specified, but it is not required which allows for generic types.</li>
<li><code>outputs</code> is an array of output parameters for this node.</li>
</ul>
<p>Note that we didn’t specify a <code>type</code> parameter for our input field. This makes it a fuzzy input and anything that supports the multiplication operator can be passed. Our output parameter does have a <code>type</code> field, but instead of defining a fixed type it uses a generic syntax that sets the output type to whatever the input type was. For more information about this syntax see the <a href="https://ourmachinery.com/apidoc/doc/shader_system_reference.md.html">Shader System Reference</a>.</p>
<h2 id="depth-output-node"><a class="header" href="#depth-output-node">Depth Output Node</a></h2>
<p><img src="https://www.dropbox.com/s/o947fbjy9uddltn/tut_creation_graph_custom_depth_output.png?dl=1" alt="" /></p>
<p>Output nodes are more complex than function nodes. Instead of a single <code>function</code> block these nodes that the form of a render pass that can have variations based on the systems used with it and the connected inputs. The example above creates a very simple material node that displays a gray-scale interpretation of the object’s distance to the viewing camera.</p>
<pre><code class="language-json">depth_stencil_states: {
	depth_test_enable: true
	depth_write_enable: true
	depth_compare_op: &quot;greater_equal&quot;
}

raster_states: {
	front_face: &quot;ccw&quot;
}

imports: [
	{ name: &quot;tm&quot; type: &quot;float4x4&quot; }
]

vertex_shader: {
	import_system_semantics: [ &quot;vertex_id&quot; ]

	code: [[
		tm_vertex_loader_context ctx;
		init_vertex_loader_context(ctx);
		float4 vp = load_position(ctx, vertex_id, 0);

		float4 wp = mul(vp, load_tm());
		output.position = mul(wp, load_camera_view_projection());
		return output;
	]]
}

pixel_shader: {
	code: [[
		float2 near_far = load_camera_near_far();
		float depth = linearize_depth(input.position.z, near_far.x, near_far.y) * 0.01f;

		output.buffer0 = float4(linear_to_gamma2(depth), 1); // Base color, alpha
		output.buffer1 = float4(1, 1, 0, 1); // Normal (encoded in signed oct)
		output.buffer2 = float4(0, 0, 0, 1); // Specular, Roughness
		output.velocity = float2(0, 0);
		return output;
	]]
}
</code></pre>
<p>The <code>creation_graph_node</code> block for this node is very small. If no outputs are specified then the output will be a <code>Shader Instance</code>. These can be passed to other nodes for rendering like the <code>Draw Call</code> and <code>Shader Instance</code> output node.</p>
<pre><code class="language-json">creation_graph_node: {
	name: &quot;depth_output&quot;
	display_name: &quot;Depth&quot;
	category: &quot;Shader/Output&quot;
}
</code></pre>
<p>In this example the <code>compile</code> block has the following fields:</p>
<ul>
<li><code>includes</code> specify which common shaders this shader is dependent on. In this example that is the <code>common.tmsl</code> shader because we use the <code>linear_to_gamma2</code> function.</li>
<li><code>contexts</code> specifies how this pass should be executed depending on the context. In this example we only support one context, the <code>viewport</code>. In this context we want to run during the <code>gbuffer</code> phase so we specify that as our layer. We also want to enable the <code>gbuffer_system</code> as we will be writing to it. Finally we specify that in this context we will enable the <code>gbuffer</code> configuration.</li>
<li><code>configurations</code> are groups of settings. In this example we have one configuration group: <code>gbuffer</code>. This configuration requests three systems, if these systems are not present then we cannot run:
<ul>
<li>The <code>viewer_system</code> is needed to query the camera information.</li>
<li>The <code>gbuffer_system</code> allows us to render to the G-Buffer in the opaque pass of the default-render-pipeline.</li>
<li>The <code>vertex_buffer_system</code> allows us to query vertex information from the mesh.</li>
</ul>
</li>
</ul>
<pre><code class="language-json">compile: {
	includes: [ &quot;common&quot; ]

	configurations: {
		gbuffer: [{ 
			variations: [{ 
				systems: [ &quot;viewer_system&quot;, &quot;gbuffer_system&quot;, &quot;vertex_buffer_system&quot; ]
			}]
		}]
	}

	contexts: {
		viewport: [
			{ layer: &quot;gbuffer&quot; enable_systems: [ &quot;gbuffer_system&quot; ] configuration: &quot;gbuffer&quot; }
		]
	}
}
</code></pre>
<blockquote>
<p><strong>Note</strong> that the available contexts are defined by the application. Some example of these in The Machinery editor are <code>viewport</code>, <code>shadow_caster</code> and <code>ray_trace_material</code>. </p>
</blockquote>
<blockquote>
<p><strong>Note</strong> that layers are defined by the render pipeline used. Some examples from the default render pipeline are: <code>gbuffer</code>, <code>skydome</code>, <code>hdr-transparency</code>, <code>ui</code>. </p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../creation_graph/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../creation_graph/custom_cpu_nodes.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../creation_graph/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../creation_graph/custom_cpu_nodes.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
