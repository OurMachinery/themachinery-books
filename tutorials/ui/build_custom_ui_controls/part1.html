<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Part 1 - The Machinery Tutorial Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item expanded "><a href="../../creation_graph/index.html"><strong aria-hidden="true">2.</strong> Creation Graph</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../creation_graph/custom_gpu_nodes.html"><strong aria-hidden="true">2.1.</strong> Creating custom GPU nodes</a></li><li class="chapter-item expanded "><a href="../../creation_graph/custom_cpu_nodes.html"><strong aria-hidden="true">2.2.</strong> Creating custom CPU nodes</a></li><li class="chapter-item expanded "><a href="../../creation_graph/from_code.html"><strong aria-hidden="true">2.3.</strong> Calling Creation Graphs from code</a></li></ol></li><li class="chapter-item expanded "><a href="../../physics/index.html"><strong aria-hidden="true">3.</strong> Physics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../physics/triggers.html"><strong aria-hidden="true">3.1.</strong> Triggers</a></li></ol></li><li class="chapter-item expanded "><a href="../../the_truth/index.html"><strong aria-hidden="true">4.</strong> The Truth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../the_truth/custom_asset/index.html"><strong aria-hidden="true">4.1.</strong> Creating a custom asset</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../the_truth/custom_asset/part1.html"><strong aria-hidden="true">4.1.1.</strong> Part 1 - Create an Asset Truth Type, Addable via Asset Browser</a></li><li class="chapter-item expanded "><a href="../../the_truth/custom_asset/part2.html"><strong aria-hidden="true">4.1.2.</strong> Part 2 - Custom UI</a></li><li class="chapter-item expanded "><a href="../../the_truth/custom_asset/part3.html"><strong aria-hidden="true">4.1.3.</strong> Part 3 - Custom Importer</a></li></ol></li><li class="chapter-item expanded "><a href="../../the_truth/drag_and_drop.html"><strong aria-hidden="true">4.2.</strong> Adding Drag and Drop to Assets</a></li></ol></li><li class="chapter-item expanded "><a href="../../ui/index.html"><strong aria-hidden="true">5.</strong> UI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ui/build_custom_ui_controls/index.html"><strong aria-hidden="true">5.1.</strong> Build Custom UI Controls</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ui/build_custom_ui_controls/part1.html" class="active"><strong aria-hidden="true">5.1.1.</strong> Part 1</a></li></ol></li><li class="chapter-item expanded "><a href="../../ui/toolbars-overlays.html"><strong aria-hidden="true">5.2.</strong> Toolbars and Overlays</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Machinery Tutorial Book</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/OurMachinery/themachinery-books" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="build-custom-ui-controls-part-i"><a class="header" href="#build-custom-ui-controls-part-i">Build Custom UI Controls, Part I</a></h1>
<p>Hi, we are starting a 3-part tutorial series about The Machinery UI system. In Part I, we’ll talk about the basics and create a custom circular button. In Part II, we’ll create a custom button with textures support. To show the results of the first two parts, we’ll be using a simple custom tab, so in Part III, we’ll see how to set up your UI and render it on screen.</p>
<p>During this tutorial, you’ll implement the <code>tm_ui_custom_controls</code> plugin, which will contain the <code>tm_ui_custom_controls_api</code> for draw custom controls in UI and <code>tm_ui_custom_controls_tab</code> custom tab in order to visualize results in a separate tab.</p>
<p><strong>Table of Content</strong></p>
<ul>
<li><a href="#environment-setup">Environment setup</a></li>
<li><a href="#circular-custom-button">Circular Custom Button:</a></li>
<li><a href="#drawing-text">Drawing text</a></li>
</ul>
<h2 id="environment-setup"><a class="header" href="#environment-setup">Environment setup</a></h2>
<p>During this tutorial, you’ll build the <code>tm_ui_custom_controls</code> plugin, which will contain the <code>tm_ui_custom_controls_api</code> for draw custom controls and <code>tm_ui_custom_controls_tab</code> custom tab in order to visualize results in a separate tab.</p>
<blockquote>
<p>The source code is hosted on <a href="https://github.com/raphael-ourmachinery/tm-custom-control-tutorial">https://github.com/raphael-ourmachinery/tm-custom-control-tutorial</a>, copy the contents of <code>skel/</code> folder to a separate directory, the final result will be available in <code>part1/</code> folder. </p>
</blockquote>
<p>Below is a list of files of our project:</p>
<ul>
<li><code>skel/libs.json</code>: specify premake5 binaries that will be downloaded from The Machinery server;</li>
<li><code>skel/(premake5.lua/build.bat/build.sh)</code>: build scripts that use <code>tmbuild.exe</code> to build our shared library. Note that we are targeting <code>TM_SDK_DIR/bin/plugins</code>, so our plugin will be automatically loaded by the engine. You’ll need to set the <code>TM_SDK_DIR</code> environment variable pointing to The Machinery directory. </li>
<li><code>skel/src/custom_tab.(c/h)</code>: this is a minimal version of the custom tab sample, which makes it easier to see our custom button;</li>
<li><code>skel/src/ui_custom_controls_loader.(c/h)</code>: load the necessary APIs, it contains the definition of <code>tm_load_plugin()</code> needed our plugin be loaded by the plugins system;</li>
<li><code>skel/src/ui_custom_controls.(c/h)</code>: implementation of our circular button, later you can extend the API with your custom controls too.</li>
</ul>
<h2 id="circular-custom-button"><a class="header" href="#circular-custom-button">Circular Custom Button:</a></h2>
<p>The Machinery uses an immediate-mode UI. You can read more about it on <a href="https://ourmachinery.com/post/one-draw-call-ui/">One Draw Call UI</a> blog post. To draw 2D shapes, we’ll be using the <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_draw2d_api"><code>tm_draw2d_api</code></a> implemented in <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html"><code>draw2d.h</code></a>, which supplies functions to draw basic 2D shapes. As we are implementing a circular button, we’ll we need to draw a circle using the following function:</p>
<pre><code>tm_draw2d_api→fill_circle(tm_draw2d_vbuffer_t *vbuffer, tm_draw2d_ibuffer_t *ibuffer, const tm_draw2d_style_t *style, tm_vec2_t pos, float radius)
</code></pre>
<p>You can note this function takes a vertex and an index buffer as arguments. In the following tutorials, we’ll learn more about it, but for now, you only need to know is that <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_draw2d_api"><code>tm_draw2d_api</code></a> will fill them, and we need to call <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.buffers()"><code>tm_ui_api-&gt;buffers()</code></a> to get the buffers. Later the engine will use <a href="https://ourmachinery.com/apidoc/plugins/ui/ui_renderer.h.html#structtm_ui_renderer_api">tm_ui_renderer_api</a> to draw the UI using one draw call.</p>
<p>Let’s add some more information <code>tm_ui_circular_button_t</code> and use it on <code>circular_button()</code>:</p>
<ul>
<li>ui_custom_controls.h:</li>
</ul>
<pre><code class="language-C">    ...
    
    typedef struct tm_ui_circular_button_t
    {
        uint64_t id;
    
        tm_vec2_t center;
        float radius;
        tm_color_srgb_t background_color;
    } tm_ui_circular_button_t;
    
    ...
</code></pre>
<ul>
<li>ui_custom_controls.c:</li>
</ul>
<pre><code class="language-C">    ...
    
    bool circular_button(struct tm_ui_o *ui, const struct tm_ui_style_t *uistyle, const tm_ui_circular_button_t *c)
    {
        // tm_ui_buffer_t contains information needed when creating a custom control
        tm_ui_buffers_t uib = tm_ui_api-&gt;buffers(ui);
    
        // convert tm_ui_style_t to tm_draw2d_style_t
        tm_draw2d_style_t style;
        tm_ui_api-&gt;to_draw_style(ui, &amp;style, uistyle);
        style.color = c-&gt;background_color;
    
        tm_draw2d_api-&gt;fill_circle(uib.vbuffer, uib.ibuffers[uistyle-&gt;buffer], &amp;style, c-&gt;center, c-&gt;radius);
    
        return false;
    }
    
    ...
</code></pre>
<p>For control interaction logic, we'll need interfaces from <a href="https://ourmachinery.com/apidoc/plugins/ui/ui_custom.h.html#ui_custom.h">ui_custom.h</a>, actually all editor's UI is implemented using them.  <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_buffers_t">tm_ui_buffers_t</a> that we got earlier has two important members, <a href="https://ourmachinery.com/apidoc/plugins/ui/ui_custom.h.html#structtm_ui_activation_t">tm_ui_activation_t</a> one keeps the information about activation and hovering state of UI controls, and <a href="https://ourmachinery.com/apidoc/plugins/ui/ui_custom.h.html#structtm_ui_input_state_t">tm_ui_input_state_t</a> maintains the input state. The table below lists some important concepts of our UI system. You can read it at once, or skip for now and return when necessary:</p>
<table><thead><tr><th><strong>Concept</strong></th><th><strong>Description</strong></th></tr></thead><tbody>
<tr><td>ID</td><td>Each control in the UI has a unique 64-bit identifier. Since controls are not explicitly created and destroyed, the ID is the only thing that identifies a control from one frame to the next.<br><br>You create a new ID by calling <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.make_id()"><code>tm_ui_api-&gt;make_id()</code></a>. IDs are assigned sequentially by the UI. You have to be a bit careful with this if you have controls that sometimes are visible and sometimes not, such as <em>context menus</em>. If you only generate the ID for the context menu when it is visible, it will change the numbering of the subsequent controls depending on whether the menu is visible or not. Since controls are identified by their IDs, this can lead to controls being misidentified.<br><br>A good strategy is to generate the IDs for all the controls that you <em>might</em> show upfront, so that the ID assignment is stable.<br><br>Note: We may change this in the future if we can find a more stable way of assigning IDs.</td></tr>
<tr><td>Hover</td><td>The UI system keeps track of which control the mouse pointer is <em>hovering</em> over, by storing its ID in a <em>hover</em> variable.<br><br>You never set the <em>hover</em> variable directly. Instead, in your control’s update, you check if the mouse is over your control with <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.is_hovering()"><code>tm_ui_api-&gt;is_hovering()</code></a>, and if it is you set <code>next_hover</code> to its ID. At the end of the frame, the UI assigns the value of <code>next_hover</code> to the <code>hover</code> variable.<br><br>The reason for this two-step process is that multiple controls or objects might be drawn on top of each other in the same area of the UI. The last object drawn will be on top and we want the <em>hover</em> variable to reflect whatever the user sees on the screen.</td></tr>
<tr><td>Overlay</td><td>The UI is actually drawn in two layers, one <em>Base</em> and one <em>Overlay</em> layer. The controls in the overlay layer are drawn on top of the controls in the <em>Base</em> layer, even if they are drawn earlier in the draw order. We use the Overlay layer for things like drop-down menus that should appear on top of other controls.<br><br>If an earlier control set <em>next_hover</em> to a control in the Overlay layer, this shouldn’t be changed by a later control in the base layer, because the Overlay layer control will appear on top of that one. We use a variable <code>next_hover_in_overlay</code> to keep track of if the current <code>next_hover</code> value represents an ID in the Overlay layer. In this case, it shouldn’t be changed by base layer controls.<br><br>In practice, the Overlay layer is implemented by keeping track of two index buffers in the drawing system, one for the base layer and one for the overlay layer. (Note that the two layers still share a single vertex buffer.) At the end of drawing, we merge the two buffers into one, by simply concatenating the Overlay buffer at the end of the base Buffer, thus making sure the overlay controls are drawn later, on top of the base control. With this approach, we can still draw everything with a single draw call.<br><br>Note that as a consequence of how we render our UI — we only have a single Vulkan context and everything is drawn with the same draw call — drop-down menus and other pop-up controls cannot extrude past the edges of the system window — everything is drawn with the system window rect.</td></tr>
<tr><td>Active</td><td>Similar to <em>Hover</em>, <em>Active</em> is a variable that keeps track of the currently active control, i.e. the control the user is currently interacting with.<br><br>We need to keep track of the active control for two reasons. First, we often want to draw the active control in a special way, such as showing a highlight and a caret in an active text box.<br><br>Second, the active control typically needs to keep track of some extra state. For example, an active slider needs to keep track of the slider’s initial position so that it can pop back to that if the user drags the mouse outside the slider.<br><br>The UI system uses a single large <code>char[]</code> buffer to keep track of the current active control’s state. This buffer is shared by all controls. Since there can only be one active control at a time, only one control will be using this buffer at a time. When a new control becomes active the buffer is zeroed (this should be a valid initial state for the active data).<br><br>Typically a control becomes active if the user presses the left mouse button while the control is being <em>hovered</em>. In this case, the control will call <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.set_active()"><code>tm_ui_api-&gt;set_active()</code></a>. Though there are other ways a control can become active too, such as by tabbing. To implement tab focus, you need to call <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.focus_on_tab()"><code>tm_ui_api-&gt;focus_on_tab()</code></a> in the control’s code.</td></tr>
<tr><td>Clipping</td><td>The drawing system has support for <em>Clipping</em> <em>Rects.</em> This is mostly useful when you need to clip text to a control’s rect. You create a new clipping rect by calling <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_draw2d_api.add_clip_rect()"><code>tm_draw2d_api-&gt;add_clip_rect()</code></a> or <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_draw2d_api.add_sub_clip_rect()"><code>tm_draw2d_api-&gt;add_sub_clip_rect()</code></a>. This gives you a clipping ID that can be passed as part of the Draw or UI style.</td></tr>
<tr><td>Responder scopes</td><td><em>Responder Scopes</em> are used to control which controls can respond to keyboard input. Typically, when a control is <em>Active</em>, it, and all its parent controls can respond to keyboard input. For example, if the control is inside a scrollview, the scrollview will respond to scroll keypresses, while the tab that hosts the scrollview may respond to commands such as Ctrl+F.<br><br>Being an immediate GUI system, <em>The Machinery</em> doesn’t have an explicit concept of “child” and “parent” controls. Instead we use the concept of <em>Responder Scopes</em>. A parent control first calls <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.begin_responder_scope()"><code>begin_responder_scope()</code></a>, then draws all its child controls and finally calls <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.end_responder_scope()"><code>end_responder_scope()</code></a>. This establishes a parent-child relationship for the purpose of keyboard interaction.<br><br>When a control becomes <em>Active</em>, the current set of Responder Scopes is saved as the <em>Responder Chain</em>. This is the list of controls that can respond to a keyboard action. To test if your control should act on keyboard input, you can call <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.in_responder_chain()"><code>in_responder_chain()</code></a>.<br><br>Note: We currently don’t have any mechanism to check if other controls in the Responder Chain have “consumed” keyboard input, so if you have multiple controls in the same chain that respond to the same keyboard command, you may run into trouble.</td></tr>
</tbody></table>
<p>Bellow, we have a higher-level view of the steps needed to implement our interaction logic:</p>
<ol>
<li>Create a id with <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.make_id()"><code>tm_ui_api→make_id()</code></a>;</li>
<li>Check if the button is already active with <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.is_active()"><code>tm_ui_api→is_active()</code></a>, it will return a pointer for a 16Kb buffer that you can use to keep custom data needed while the button is active;</li>
<li>Check if the mouse is hovering the button, and set activation <code>next_hover</code> variable according. At the end of the frame, the UI system will set hover to our control id case no other control changed next_hover after us;</li>
<li>Case the hover variable contains our control id and mouse is pressed, set it as the active one, which is done which <a href="https://ourmachinery.com/apidoc/plugins/render_graph/render_graph.h.html#structtm_render_graph_setup_api.set_active()"><code>tm_ui_api→set_active()</code></a>, a pointer to the 16Kb buffer will be returned so you can cast it to control custom data, note that we need to pass a hash to the function identifying this data;</li>
<li>Case our button is active and mouse was released, the control is considered clicked, and we call <a href="https://ourmachinery.com/apidoc/plugins/ui/ui.h.html#structtm_ui_api.clear_active()"><code>tm_ui_api→clear_active()</code></a> to deactivate him;</li>
<li>Now we can check if the mouse is hovering our control and use either the active or hovering color depending on we are the active control or not;</li>
</ol>
<p>With this in mind, the complete code will be the following:</p>
<ul>
<li>ui_custom_controls.h:</li>
</ul>
<pre><code class="language-C">    ...
    typedef struct tm_ui_circular_button_data_t {
        const char *name;
        uint32_t frames_active;
    } tm_ui_circular_button_data_t;
    
    typedef struct tm_ui_circular_button_t
    {
        uint64_t id;
    
        tm_vec2_t center;
        float radius;
        tm_color_srgb_t background_color;
        tm_color_srgb_t hover_color;
        tm_color_srgb_t clicked_color;
    
        const char *text;
        const struct tm_color_srgb_t text_color;
    } tm_ui_circular_button_t;
    ...
</code></pre>
<ul>
<li>ui_custom_controls.c:</li>
</ul>
<pre><code class="language-C">    ...
    
    bool circular_button(struct tm_ui_o *ui, const struct tm_ui_style_t *uistyle, const tm_ui_circular_button_t *c)
    {
        // Step 1
        // tm_ui_buffer_t contains information needed when creating a custom control
        tm_ui_buffers_t uib = tm_ui_api-&gt;buffers(ui);
        const uint64_t id = c-&gt;id ? c-&gt;id : tm_ui_api-&gt;make_id(ui);
        
        // Step 2
        // is_active will return a pointer for user defined data up to 16KB
        tm_ui_circular_button_data_t *active = (tm_ui_circular_button_data_t *)tm_ui_api-&gt;is_active(ui, id, TM_UI_ACTIVE_DATA__CIRCULAR_BUTTON);
        if (active) {
            TM_LOG(&quot;active data -&gt; name: %s, frames_active: %u\n&quot;, active-&gt;name, active-&gt;frames_active);
            active-&gt;frames_active++;
        }
    
        // convert tm_ui_style_t to tm_draw2d_style_t
        tm_draw2d_style_t style;
        tm_ui_api-&gt;to_draw_style(ui, &amp;style, uistyle);
        style.color = c-&gt;background_color;
        
        // Step 3
        bool clicked = false;
        bool inside = tm_vec2_in_circle(uib.input-&gt;mouse_pos, c-&gt;center, c-&gt;radius);
        if (inside)
            uib.activation-&gt;next_hover = id;
        
        // Step 4
        if (uib.activation-&gt;hover == id &amp;&amp; uib.input-&gt;left_mouse_pressed) {
            active = tm_ui_api-&gt;set_active(ui, id, TM_UI_ACTIVE_DATA__CIRCULAR_BUTTON);
            if (active)
                *active = (tm_ui_circular_button_data_t){ .name = &quot;circular_button&quot;, .frames_active = 0 };
            tm_ui_api-&gt;set_responder_chain(ui, 0);
        }
        
        // Step 5
        if (active &amp;&amp; uib.input-&gt;left_mouse_released) {
            clicked = inside;
            tm_ui_api-&gt;clear_active(ui);
        }
        
        // Step 6
        if (inside) {
            if (active)
                style.color = c-&gt;clicked_color;
            else if (uib.activation-&gt;hover == id)
                style.color = c-&gt;hover_color;
        }
    
        tm_ui_api-&gt;reserve_draw_memory(ui);
        tm_draw2d_api-&gt;fill_circle(uib.vbuffer, uib.ibuffers[uistyle-&gt;buffer], &amp;style, c-&gt;center, c-&gt;radius);
    
        return clicked;
    }
    
    ...
</code></pre>
<h2 id="drawing-text"><a class="header" href="#drawing-text">Drawing text</a></h2>
<p>The last thing we need is to draw some text inside our button. You'll need to call <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_draw2d_api.draw_glyphs()"><code>tm_draw2d_api→draw_glyphs()</code></a> to fill UI buffers with text information. It takes as one of its arguments an array of glyphs indices that point to the corresponding <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_font_glyph_t">tm_font_glyph_t</a> glyph inside the <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_font_t">tm_font_t</a> structure. To get this information, we first need to convert the desired text to an array of codepoints using <a href="https://ourmachinery.com/apidoc/foundation/unicode.h.html#structtm_unicode_api.utf8_decode_n()"><code>tm_unicode_api→utf8_decode_n()</code></a> and pass them to <a href="https://ourmachinery.com/apidoc/plugins/ui/draw2d.h.html#structtm_font_api.glyphs()"><code>tm_font_api→glyphs()</code></a> . Thus, add the following lines to the source code:</p>
<p>With this in mind, the complete code will be the following:</p>
<ul>
<li>ui_custom_controls.h:</li>
</ul>
<pre><code class="language-C">    ...
    
    typedef struct tm_ui_circular_button_t
    {
       ...
        uint32_t icon;
        const char *text;
        const struct tm_color_srgb_t text_color;
    } tm_ui_circular_button_t;
    ...
</code></pre>
<ul>
<li>ui_custom_controls.c:</li>
</ul>
<pre><code class="language-C">    ...
    
    bool circular_button(struct tm_ui_o *ui, const struct tm_ui_style_t *uistyle, const tm_ui_circular_button_t *c)
    {
        ...
        // Inscribe a quad in button circle
        const float side = c-&gt;radius * sqrtf(2);
        tm_rect_t text_rect = tm_rect_center_dim(c-&gt;center, (tm_vec2_t){ side, side });
    
        tm_ui_api-&gt;reserve_draw_memory(ui);
        style.clip = tm_draw2d_api-&gt;add_sub_clip_rect(uib.vbuffer, style.clip, text_rect);
    
        // Get glyphs from our text
        uint16_t glyphs[128];
        uint32_t n = 0;
        {
            uint32_t codepoints[128];
            n = tm_unicode_api-&gt;utf8_decode_n(codepoints, 128, tm_or(c-&gt;text, &quot;&quot;));
            tm_font_api-&gt;glyphs(style.font-&gt;info, glyphs, codepoints, 128);
        }
        tm_vec2_t text_pos = {
            .x = c-&gt;center.x - side / 2.f,
            .y = middle_baseline(text_rect.y, text_rect.h, style.font-&gt;info, 1.f),
        };
        style.color = c-&gt;text_color;
        tm_draw2d_api-&gt;draw_glyphs(uib.vbuffer, uib.ibuffers[uistyle-&gt;buffer], &amp;style, text_pos, glyphs, n);
    
        return clicked;
    }
    
    ...
</code></pre>
<p>We now have a custom button implementation that can be used across your projects. Please extend it and show us your results.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../ui/build_custom_ui_controls/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../ui/toolbars-overlays.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../ui/build_custom_ui_controls/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../ui/toolbars-overlays.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
